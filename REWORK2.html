<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>QU·∫¢N L√ù REWORK</title>
  <style>
    /* Common styles */
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f7fa; }
    .container { padding: 20px; }
    .tab-buttons { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    .tab-buttons button {
      padding: 10px 20px; border: none; border-radius: 6px;
      background: #34495e; color: #fff; cursor: pointer;
    }
    .tab-buttons button.active { background: #27ae60; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Tab 1: Qu·∫£n l√Ω rework */
    .app-container { display: flex; flex-direction: row; }
    .left, .right { padding: 20px; overflow-y: auto; }
    .left { width: 40%; border-right: 2px solid #ccc; position: relative; }
    .right { width: 60%; }
    label { font-weight: bold; display: block; margin: 10px 0 5px; }
    input, select, textarea { padding: 5px; width: 200px; margin-bottom: 10px; }
    button { padding: 8px 16px; margin: 6px; border-radius: 6px; border: 1px solid #333; font-size: 14px; cursor: pointer; }
    #completeBtn { color: green; }
    #pendingBtn { color: orange; }
    #error { color: red; font-weight: bold; margin-top: 10px; }
    table { margin-top: 10px; border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #eee; }
    .rework-completed { background-color: #d4edda; }
    .rework-pending { background-color: #fff3cd; }
    #loginScreen { margin-top: 50px; text-align: center; }
    .mainApp { display: none; }
    #clearLogBtn, #resetDataBtn { position: absolute; top: 12px; padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; }
    #clearLogBtn { right: 120px; background: #3498db; color: white; }
    #clearLogBtn:hover { background: #2980b9; }
    #resetDataBtn { right: 12px; background: #e74c3c; color: white; }
    #resetDataBtn:hover { background: #c0392b; }
    .stat { margin-top: 8px; font-size: 14px; }
    
    /* Tab 2: D·ªØ li·ªáu PRO (TEST) */
    .ref-status { margin-bottom:8px; font-weight:bold; }
    
    /* Tab 3: L·ªçc d·ªØ li·ªáu */
    .filter-container { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
    .filter-item { display: flex; flex-direction: column; }
    .filter-item label { font-size: 13px; color: #555; margin-bottom: 4px; }
    .filter-item input, .filter-item select {
      padding: 8px 10px; border-radius: 6px; border: 1px solid #ccc; min-width: 150px; background: #fff;
    }
    .button-container { display: flex; gap: 10px; margin-bottom: 20px; }
    .btn-filter {
      background: #34495e; color: #fff; padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;
    }
    .btn-filter:hover { background: #2c3e50; }
    .btn-download {
      background: #27ae60; color: #fff; padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;
    }
    .btn-download:hover { background: #1e874b; }
    
    /* Th√™m style cho th√¥ng b√°o */
    .sync-status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      display: none;
    }
    .sync-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .sync-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .sync-pending {
  background-color: #fff3cd;
  color: #856404;
  border: 1px solid #ffeaa7;
}
    /* Status badges */
    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: bold;
      font-size: 12px;
    }
    .status-completed {
      background-color: #28a745;
      color: white;
    }
    .status-pending {
      background-color: #ffc107;
      color: black;
    }
    
    
    /* L·ªãch s·ª≠ QR code */
    .qr-history {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      max-height: 300px;
      overflow-y: auto;
      display: none;
    }
    .qr-history h4 {
      margin-top: 0;
      color: #2c3e50;
      border-bottom: 2px solid #3498db;
      padding-bottom: 8px;
    }
    .history-item {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .history-date {
      font-size: 12px;
      color: #6c757d;
    }
    .history-content {
      font-size: 14px;
    }
    .history-error {
      color: #dc3545;
      font-weight: bold;
    }
    .history-action {
      color: #28a745;
      margin: 5px 0;
    }
    .history-note {
      color: #6c757d;
      font-style: italic;
    }
    .no-history {
      text-align: center;
      color: #6c757d;
      font-style: italic;
      padding: 20px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/clusterize.js@0.18.1/clusterize.min.js"></script>
</head>
<body>
     <div style="margin-top:20px; display:flex; gap:10px; ">
      <img src="logo.png" alt="Logo" style="height: 100px; width: auto; margin-right: 20px;">
      <h2>üîÑ QU·∫¢N L√ù REWORK</h2>
      </div>
     </div>

    <div class="tab-buttons">
      <button id="btnTab1" class="active" onclick="showTab(1)">üìù Qu·∫£n l√Ω rework</button>
      <button id="btnTab2" onclick="showTab(2)">üßæ D·ªØ li·ªáu PRO (TEST)</button>
      <button id="btnTab3" onclick="showTab(3)">üìë D·ªØ li·ªáu rework</button>
      <button id="btnTab4" onclick="showTab(4)">üîß PQC</button>
      <button id="btnTab5" onclick="showTab(5)">üìä OQC</button>
    </div>
    
    <!-- Tab 1: Qu·∫£n l√Ω rework -->
    <div id="tab1" class="tab-content active">
      <!-- M√†n h√¨nh ƒëƒÉng nh·∫≠p -->
      <div id="loginScreen">
        <h2>ƒêƒÉng nh·∫≠p</h2>
        <label for="loginUser">T√™n ƒëƒÉng nh·∫≠p</label>
        <input type="text" id="loginUser" placeholder="Nh·∫≠p m√£ s·ªë nh√¢n vi√™n">

        <label for="loginPass">M·∫≠t kh·∫©u</label>
        <input type="password" id="loginPass" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">

        <label for="shift">Ch·ªçn ca</label>
        <select id="shift">
          <option value="Ca 1 (06:00-14:00)">Ca 1 (06:00 - 14:00)</option>
          <option value="Ca 2 (14:00-22:00)">Ca 2 (14:00 - 22:00)</option>
          <option value="Ca 1 d√†i (06:00-18:00)">Ca 1 d√†i (06:00 - 18:00)</option>
          <option value="Ca 2 d√†i (18:00-06:00)">Ca 2 d√†i (18:00 - 06:00 h√¥m sau)</option>
          <option value="Ca HC (08:00-16:30)">Ca HC (08:00 - 16:30)</option>
        </select>

        <label for="wo">S·ªë l·ªánh s·∫£n xu·∫•t (WO)</label>
        <input type="text" id="wo" placeholder="Nh·∫≠p s·ªë WO" oninput="this.value=this.value.toUpperCase()">

        <br>
        <button onclick="login()">ƒêƒÉng nh·∫≠p</button>
        <p id="loginError" style="color:red;"></p>
      </div>

      <!-- Giao di·ªán ch√≠nh -->
      <div id="mainApp" class="mainApp app-container">
        <!-- C·ªôt tr√°i -->
        <div class="left">
          <h2>Qu·∫£n l√Ω Rework</h2>
          <button id="clearLogBtn" onclick="clearLogDisplay()">X√≥a log</button>
          <button id="resetDataBtn" onclick="resetAllData()">Reset d·ªØ li·ªáu</button>

          <p class="stat">üë§ Ng∆∞·ªùi th·ª±c hi·ªán: <b id="currentUser"></b></p>
          <p class="stat">üïí Ca: <b id="currentShift"></b></p>
          <p class="stat">üìã WO: <b id="currentWO"></b></p>
          <p class="stat">‚úÖ Ho√†n th√†nh: <b id="completedCount">0</b> | ‚è≥ ƒêang x·ª≠ l√Ω: <b id="pendingCount">0</b></p>

          <label for="mahang">M√£ h√†ng</label>
          <select id="mahang">
            <option value="">-- Ch·ªçn m√£ h√†ng --</option>
            <option value="ECM-2583-236">ECM-2583-236</option>
            <option value="ECM-2583-164">ECM-2583-164</option>
            <option value="ECM-2300">ECM-2300</option>
            <option value="ECM-2310">ECM-2310</option>
            <option value="IZ-1-R3">IZ-1-R3</option>
            <option value="RM-4K-R3">RM-4K-R3</option>
            <option value="AM-4-R3">AM-4-R3</option>
            <option value="AUT0003251">AUT0003251</option>
            <option value="AUT0004945">AUT0004945</option>
            <option value="P-7937">P-7937</option>
            <option value="P-8105">P-8105</option>
            <option value="P-8149">P-8149</option>
            <option value="BMS 85AH">BMS 85AH</option>
            <option value="BMS 57AH">BMS 57AH</option>
            <option value="CONTROLLER">CONTROLLER</option>
            <option value="CAS NEMO">CAS NEMO</option>
            <option value="CAS MINI-DI">CAS MINI-DI</option>
            <option value="CAS MINI-485">CAS MINI-485</option>
            <option value="BN 2573A">BN 2573A</option>
            <option value="OEM">OEM</option>
          </select>

          <label for="qrcode">QR Code s·∫£n ph·∫©m</label>
          <input type="text" id="qrcode" placeholder="Qu√©t QR code s·∫£n ph·∫©m" oninput="handleQRCodeInput(this.value)">

          <!-- L·ªãch s·ª≠ QR code -->
          <div id="qrHistory" class="qr-history" style="display: none;">
            <h4>üìã L·ªãch s·ª≠ x·ª≠ l√Ω QR Code: <span id="currentQRCode"></span></h4>
            <div id="historyContent"></div>
          </div>

          <label for="loi">L·ªói c·∫ßn s·ª≠a</label>
          <div style="display: flex; gap: 10px;">
            <input list="errorList" id="loi" placeholder="Ch·ªçn l·ªói c·∫ßn s·ª≠a">
            <input type="text" id="ghichu" placeholder="Ghi ch√∫ th√™m (n·∫øu c√≥)">
          </div>
          <datalist id="errorList">
            <option value="√ÅP CAO">√ÅP CAO</option>
            <option value="√ÅP TH·∫§P">√ÅP TH·∫§P</option>
            <option value="HALL SENSOR">HALL SENSOR</option>
            <option value="R CAO">R CAO</option>
            <option value="LAMDA FAIL">LAMDA FAIL</option>
            <option value="KH√îNG N·∫†P ƒê∆Ø·ª¢C CODE">KH√îNG N·∫†P ƒê∆Ø·ª¢C CODE</option>
            <option value="KH√îNG K·∫æT N·ªêI ƒê∆Ø·ª¢C V·ªöI M√ÅY T√çNH">KH√îNG K·∫æT N·ªêI ƒê∆Ø·ª¢C V·ªöI M√ÅY T√çNH</option>
            <option value="VƒÇN TAY GA KH√îNG L√äN">VƒÇN TAY GA KH√îNG L√äN</option>
            <option value="N·ªî T·ª§ NH·ªé">N·ªî T·ª§ NH·ªé</option>
            <option value="D√íNG CAO">D√íNG CAO</option>
            <option value="V DISCHARGE TH·∫§P">V DISCHARGE TH·∫§P</option>
            <option value="V CHARGE TH√ÇP">V CHARGE TH√ÇP</option>
            <option value="V > 30V">V > 30V</option>
            <option value="L·ªói 3M">L·ªói 3M</option>
            <option value="C13,C14">C13,C14</option>
            <option value="C5,C6">C5,C6</option>
            <option value="C12,C13">C12,C13</option>
            <option value="C23">C23</option>
            <option value="NTC1">NTC1</option>
            <option value="NTC2">NTC2</option>
            <option value="TOP AFE">TOP AFE</option>
          </datalist>

          <label for="reworkAction">H√†nh ƒë·ªông s·ª≠a ch·ªØa</label>
          <textarea id="reworkAction" placeholder="M√¥ t·∫£ h√†nh ƒë·ªông s·ª≠a ch·ªØa ƒë√£ th·ª±c hi·ªán..." rows="3" style="width: 100%;"></textarea>

          <div>
            <button id="completeBtn" onclick="saveRework('COMPLETED')">‚úÖ Ho√†n th√†nh</button>
            <button id="pendingBtn" onclick="saveRework('PENDING')">‚è≥ ƒêang x·ª≠ l√Ω</button>
          </div>
        
          <p id="error"></p>

          <!-- Th√¥ng b√°o tr·∫°ng th√°i ƒë·ªìng b·ªô -->
          <div id="syncStatus" class="sync-status"></div>

          <div>
            <button onclick="exportCSV()">Xu·∫•t logfile</button>
            <button onclick="syncToSheet()">ƒê·ªìng b·ªô Google Sheets</button>
            <button onclick="endShiftReport()">B√°o c√°o cu·ªëi ca</button>
          </div>

          <!-- Bi·ªÉu ƒë·ªì realtime -->
          <div>
            <h3>B√°o c√°o real-time</h3>
            <div style="width: 200px; height: 200px;">
              <canvas id="chartRework"></canvas>
            </div>
          </div>
        </div>

        <!-- C·ªôt ph·∫£i -->
        <div class="right">
          <!-- B·ªô l·ªçc -->
          <div>
            <input type="text" id="searchBox" placeholder="T√¨m QR / M√£ h√†ng" onkeyup="renderTable()">
            <select id="filterStatus" onchange="renderTable()">
              <option value="">--T·∫•t c·∫£--</option>
              <option value="COMPLETED">Ho√†n th√†nh</option>
              <option value="PENDING">ƒêang x·ª≠ l√Ω</option>
            </select>
          </div>
          <table id="logTable">
            <thead>
              <tr>
                <th>M√£ h√†ng</th>
                <th>QR Code</th>
                <th>Tr·∫°ng th√°i</th>
                <th>L·ªói c·∫ßn s·ª≠a</th>
                <th>H√†nh ƒë·ªông s·ª≠a ch·ªØa</th>
                <th>Ng√†y</th>
                <th>Gi·ªù</th>
                <th>Ng∆∞·ªùi th·ª±c hi·ªán</th>
                <th>Shift</th>
                <th>PO</th>
                <th>Ghi ch√∫</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Tab 2: D·ªØ li·ªáu PRO (TEST) -->
    <div id="tab2" class="tab-content">
      <h3>üßæ D·ªÆ LI·ªÜU PRO (TEST)</h3>
      <p class="ref-status" id="refStatus">‚è≥ ƒêang ch·ªù t·∫£i d·ªØ li·ªáu PRO...</p>
      <div style="margin-bottom:10px;">
        <small>URL PRO Sheet:</small>
        <div style="margin-top:6px;">
          <input type="text" id="refUrlPreview" style="width:60%" readonly>
        </div>
      </div>

      <div style="height:400px; overflow:auto; border:1px solid #ccc; border-radius:6px; padding:8px;">
        <table id="refTable" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th>M√£ h√†ng</th>
              <th>QR code</th>
              <th>Ph√°n ƒë·ªãnh</th>
              <th>M√¥ t·∫£ l·ªói</th>
              <th>Gi·ªù</th>
              <th>Ng√†y</th>
              <th>S·ªë l·∫ßn xu·∫•t hi·ªán</th>
              <th>M√£ Nh√¢n Vi√™n</th>
              <th>Ca l√†m vi·ªác</th>
              <th>PO</th>
              <th>Ghi ch√∫</th>
            </tr>
          </thead>
          <tbody id="refTableBody"></tbody>
        </table>
      </div>
      <div id="refCount" style="margin-top:8px;font-weight:bold;"></div>
    </div>
    
    <!-- Tab 3: D·ªØ li·ªáu rework -->
    <div id="tab3" class="tab-content">
      <h3>üìë D·ªÆ LI·ªÜU REWORK</h3>
      <div class="filter-container">
        <div class="filter-item">
          <label for="fromDate">T·ª´ ng√†y</label>
          <input type="date" id="fromDate">
        </div>
        <div class="filter-item">
          <label for="toDate">ƒê·∫øn ng√†y</label>
          <input type="date" id="toDate">
        </div>
        <div class="filter-item">
          <label for="maSP">M√£ s·∫£n ph·∫©m</label>
          <select id="maSP"><option value="">T·∫•t c·∫£ m√£</option></select>
        </div>
        <div class="filter-item">
          <label for="searchQR">T√¨m QR Code</label>
          <input type="text" id="searchQR" placeholder="Nh·∫≠p QR Code ƒë·ªÉ l·ªçc..." oninput="applyFilters()">
        </div>
        <div class="filter-item">
          <label for="po">PO</label>
          <select id="po"><option value="">T·∫•t c·∫£ PO</option></select>
        </div>
        <div class="filter-item">
          <label for="statusFilter">Tr·∫°ng th√°i</label>
          <select id="statusFilter" onchange="applyFilters()">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="COMPLETED">Ho√†n th√†nh</option>
            <option value="PENDING">ƒêang x·ª≠ l√Ω</option>
          </select>
        </div>
      </div>

      <div class="button-container">
        <button class="btn-filter" onclick="applyFilters()">L·ªçc d·ªØ li·ªáu</button>
        <button class="btn-download" onclick="reloadFromGoogle()">‚≠Æ T·∫£i t·ª´ Google Sheets</button>
      </div>

      <div id="scrollArea" style="height:500px; overflow:auto; border:1px solid #ccc;">
        <table id="reportTable" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th>M√£ H√†ng</th>
              <th>QR Code</th>
              <th>Tr·∫°ng th√°i</th>
              <th>L·ªói c·∫ßn s·ª≠a</th>
              <th>H√†nh ƒë·ªông s·ª≠a ch·ªØa</th>
              <th>Gi·ªù</th>
              <th>Ng√†y</th>
              <th>Ng∆∞·ªùi th·ª±c hi·ªán</th>
              <th>Ca</th>
              <th>PO</th>
              <th>Ghi ch√∫</th>
            </tr>
          </thead>
          <tbody id="clusterize-content" class="clusterize-content"></tbody>
        </table>

        <div id="clusterize-scroll" class="clusterize-scroll"></div>
      </div>

      <div id="recordCount" style="margin-top:5px; font-weight:bold;"></div>
    </div>
    
    <!-- Tab 4: PQC -->
    <div id="tab4" class="tab-content">
      <h3>üîß D·ªÆ LI·ªÜU PQC</h3>
      <p class="ref-status" id="sauTestStatus">‚è≥ ƒêang ch·ªù t·∫£i d·ªØ li·ªáu PQC...</p>
      <div style="margin-bottom:10px;">
        <small>URL L·∫Øp R√°p Sheet:</small>
        <div style="margin-top:6px;">
          <input type="text" id="sauTestUrlPreview" style="width:60%" readonly>
        </div>
      </div>

      <div style="height:400px; overflow:auto; border:1px solid #ccc; border-radius:6px; padding:8px;">
        <table id="sauTestTable" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th>M√£ h√†ng</th>
              <th>QR code</th>
              <th>Ph√°n ƒë·ªãnh</th>
              <th>M√¥ t·∫£ l·ªói</th>
              <th>Gi·ªù</th>
              <th>Ng√†y</th>
              <th>S·ªë l·∫ßn xu·∫•t hi·ªán</th>
              <th>M√£ Nh√¢n Vi√™n</th>
              <th>Ca l√†m vi·ªác</th>
              <th>PO</th>
              <th>Ghi ch√∫</th>
            </tr>
          </thead>
          <tbody id="sauTestTableBody"></tbody>
        </table>
      </div>
      <div id="sauTestCount" style="margin-top:8px;font-weight:bold;"></div>
    </div>
    
    <!-- Tab 5: OQC -->
    <div id="tab5" class="tab-content">
      <h3>üìä D·ªÆ LI·ªÜU OQC</h3>
      <p class="ref-status" id="oqcStatus">‚è≥ ƒêang ch·ªù t·∫£i d·ªØ li·ªáu OQC...</p>
      <div style="margin-bottom:10px;">
        <small>URL OQC Sheet:</small>
        <div style="margin-top:6px;">
          <input type="text" id="oqcUrlPreview" style="width:60%" readonly>
        </div>
      </div>

      <div style="height:400px; overflow:auto; border:1px solid #ccc; border-radius:6px; padding:8px;">
        <table id="oqcTable" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th>M√£ h√†ng</th>
              <th>QR code</th>
              <th>Ph√°n ƒë·ªãnh</th>
              <th>M√¥ t·∫£ l·ªói</th>
              <th>Gi·ªù</th>
              <th>Ng√†y</th>
              <th>S·ªë l·∫ßn xu·∫•t hi·ªán</th>
              <th>M√£ Nh√¢n Vi√™n</th>
              <th>Ca l√†m vi·ªác</th>
              <th>PO</th>
              <th>Ghi ch√∫</th>
            </tr>
          </thead>
          <tbody id="oqcTableBody"></tbody>
        </table>
      </div>
      <div id="oqcCount" style="margin-top:8px;font-weight:bold;"></div>
    </div>
  </div>

  <script>
    // ===== C·∫§U H√åNH GOOGLE SHEETS =====
    const PRO_SHEET_URL = "https://script.google.com/macros/s/AKfycbwGCEDo7faBhEh9FCv1ZlrfINyAvfwIg9EbXk-CqwZRYBKVOQJP2hIGjI02JbeWIYJC5A/exec";
    const REWORK_SHEET_URL = "https://script.google.com/macros/s/AKfycbxV1KObUDfroVqCsKJdz2TYCZsvbpNbVSyEyA6-a3EUDOT46FJWnwK1dTgPzzRxxFQL/exec";
    const LAP_RAP_SHEET_URL = "https://script.google.com/macros/s/AKfycbylfaBg90qt9o8fWu83cevhmAXKn3Azg1ivs0NLC62TxtSKlDvT4xuuiO00y1mUPQI9nw/exec";
    const OQC_SHEET_URL = "https://script.google.com/macros/s/AKfycbwOt6HhlzmBT2PbhA_0qfwF7rlcrJ4XVPVQcPlh4YeswQ90DQ6rDYmCZl8OV6kqUtV1/exec";

    // Bi·∫øn to√†n c·ª•c cho datasets
    let proData = [];      // D·ªØ li·ªáu t·ª´ Sheet PRO
    let allData = [];      // D·ªØ li·ªáu t·ª´ Sheet Rework
    let sauTestData = [];  // D·ªØ li·ªáu t·ª´ Sheet L·∫Øp R√°p (PQC)
    let oqcData = [];      // D·ªØ li·ªáu t·ª´ Sheet OQC

    // ===== H√ÄM QU·∫¢N L√ù TAB =====
    function showTab(n) {
      document.querySelectorAll('.tab-buttons button').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById('btnTab' + n).classList.add('active');
      document.getElementById('tab' + n).classList.add('active');
      
      if (n === 2) {
        loadReferenceData();
      } else if (n === 3) {
        // Tab 3: D·ªØ li·ªáu rework
        if (!window.preventAutoReload) {
          reloadFromGoogle();
        }
      } else if (n === 4) {
        // Tab 4: PQC
        loadSauTestData();
      } else if (n === 5) {
        // Tab 5: OQC
        loadOQCData();
      }
    }

    // ===== PH·∫¶N QU·∫¢N L√ù REWORK =====
    const users = {
      "5035": "123456",
      "4549": "130417", // H√íA
      "5649": "100200", // LONG
      "5841": "584111", // HI·∫æU
    };

    // records[0] l√† header
    let records = [["M√£ h√†ng","QR Code","Tr·∫°ng th√°i","L·ªói c·∫ßn s·ª≠a","H√†nh ƒë·ªông s·ª≠a ch·ªØa","Gi·ªù","Ng√†y","Ng∆∞·ªùi th·ª±c hi·ªán","Ca","WO","Ghi ch√∫","Synced"]];
    let completedCount = 0, pendingCount = 0;
    let chart;

    let currentUser = "";
    let currentShift = "";
    let currentWO = "";

    // Load t·ª´ localStorage
    if (localStorage.getItem("records")) {
      try { 
        const savedRecords = JSON.parse(localStorage.getItem("records"));
        if (Array.isArray(savedRecords) && savedRecords.length > 0) {
          records = savedRecords;
        }
      } catch(e) { 
        console.error("L·ªói khi load records t·ª´ localStorage:", e);
      }
    }

    /* ===== HI·ªÇN TH·ªä L·ªäCH S·ª¨ QR CODE ===== */
    function handleQRCodeInput(qrCode) {
      if (qrCode.length > 5) {
        showQRHistory(qrCode.toUpperCase());
      } else {
        hideQRHistory();
      }
    }

    /* ===== HI·ªÇN TH·ªä L·ªäCH S·ª¨ QR CODE ===== */
/* ===== HI·ªÇN TH·ªä L·ªäCH S·ª¨ QR CODE - CH·ªà L·∫§Y TR·∫†NG TH√ÅI CU·ªêI C√ôNG (KH√îNG BAO G·ªíM LOCAL) ===== */
function showQRHistory(qrCode) {
  const historyContainer = document.getElementById('qrHistory');
  const currentQRCodeSpan = document.getElementById('currentQRCode');
  const historyContent = document.getElementById('historyContent');
  
  console.log("üîç T√¨m ki·∫øm l·ªãch s·ª≠ cho QR:", qrCode);
  
  // ƒê·ªëi t∆∞·ª£ng l∆∞u tr·∫°ng th√°i cu·ªëi c√πng c·ªßa t·ª´ng ngu·ªìn (KH√îNG BAO G·ªíM LOCAL)
  const latestStatusBySource = {};
  
  // H√†m convert timestamp
  function convertTimestamp(timestamp) {
    if (!timestamp) return null;
    
    if (typeof timestamp === "number") {
      try {
        const excelBaseDate = new Date(1899, 11, 30).getTime();
        const excelTimestamp = excelBaseDate + (timestamp - 1) * 24 * 60 * 60 * 1000;
        const date = new Date(excelTimestamp);
        const vietnamDate = new Date(date.getTime() + 7 * 60 * 60 * 1000);
        return vietnamDate;
      } catch (e) {
        console.error("L·ªói convert timestamp:", e);
        return null;
      }
    }
    
    if (typeof timestamp === "string") {
      try {
        return new Date(timestamp);
      } catch (e) {
        return null;
      }
    }
    
    return null;
  }

  // H√†m ph·ª• tr·ª£ ƒë·ªÉ l·∫•y timestamp t·ª´ record
  function getTimestampFromRecord(record) {
    const dateObj = convertTimestamp(record["Ng√†y"] || record.ngay || record["Date"]);
    const timeObj = convertTimestamp(record["Gi·ªù"] || record.gio || record["Time"]);
    
    if (dateObj && timeObj) {
      return new Date(
        dateObj.getFullYear(),
        dateObj.getMonth(),
        dateObj.getDate(),
        timeObj.getHours(),
        timeObj.getMinutes(),
        timeObj.getSeconds()
      ).getTime();
    } else if (dateObj) {
      return dateObj.getTime();
    }
    
    return 0;
  }

  // H√†m ph·ª• tr·ª£ ƒë·ªÉ t·∫°o Date object t·ª´ record
  function createDateFromRecord(record) {
    if (record.ngay && record.gio) {
      try {
        const [day, month, year] = record.ngay.split('/');
        const [hour, minute, second] = record.gio.split(':');
        return new Date(year, month - 1, day, hour, minute, second || 0);
      } catch (e) {
        return new Date(0);
      }
    } else if (record.ngay) {
      try {
        const [day, month, year] = record.ngay.split('/');
        return new Date(year, month - 1, day);
      } catch (e) {
        return new Date(0);
      }
    } else {
      return new Date(0);
    }
  }

  // ‚ùå ƒê√É X√ìA PH·∫¶N T√åM KI·∫æM TRONG RECORDS LOCAL

  // 1. T√¨m trong proData (d·ªØ li·ªáu PRO t·ª´ Tab 2) - l·∫•y b·∫£n ghi m·ªõi nh·∫•t
  let latestPro = null;
  let latestProTimestamp = 0;
  
  if (proData && proData.length > 0) {
    console.log("üîç ƒêang t√¨m trong proData:", proData.length, "b·∫£n ghi");
    proData.forEach((r) => {
      const qrValue = (
        r["QR Code"] || 
        r["QR code"] || 
        r["Qr code"] ||
        r.qrCode || 
        r.qr || 
        r["QRCode"] || 
        ""
      ).toString().trim().toUpperCase();
      
      if (qrValue === qrCode.toUpperCase()) {
        const timestamp = getTimestampFromRecord(r);
        if (timestamp > latestProTimestamp) {
          latestProTimestamp = timestamp;
          latestPro = r;
        }
      }
    });
    
    if (latestPro) {
      const timeObj = convertTimestamp(latestPro["Gi·ªù"] || latestPro.gio || latestPro["Time"]);
      const dateObj = convertTimestamp(latestPro["Ng√†y"] || latestPro.ngay || latestPro["Date"]);
      
      const gio = timeObj ? 
        `${String(timeObj.getHours()).padStart(2, '0')}:${String(timeObj.getMinutes()).padStart(2, '0')}:${String(timeObj.getSeconds()).padStart(2, '0')}` : 
        "";
      
      const ngay = dateObj ? 
        `${String(dateObj.getDate()).padStart(2, '0')}/${String(dateObj.getMonth() + 1).padStart(2, '0')}/${dateObj.getFullYear()}` : 
        "";

      latestStatusBySource['pro'] = {
        source: 'pro',
        data: latestPro,
        maHang: latestPro["M√£ h√†ng"] || latestPro.maHang || latestPro["M√£ H√†ng"] || "",
        qrCode: qrCode.toUpperCase(),
        status: latestPro["Ph√°n ƒë·ªãnh"] || latestPro["K·∫øt qu·∫£"] || latestPro.phanDinh || "",
        loi: latestPro["M√¥ t·∫£ l·ªói"] || latestPro.moTaLoi || latestPro["L·ªói"] || "",
        action: "",
        gio: gio,
        ngay: ngay,
        nguoiThucHien: latestPro["M√£ Nh√¢n Vi√™n"] || latestPro.maNV || latestPro.User || latestPro["Nh√¢n vi√™n"] || "",
        ca: latestPro["Ca l√†m vi·ªác"] || latestPro.caLam || latestPro.Shift || latestPro["Ca"] || "",
        wo: latestPro["PO"] || latestPro.po || latestPro["WO"] || latestPro["S·ªë WO"] || "",
        ghichu: latestPro["Ghi ch√∫"] || latestPro.ghichu || latestPro["Note"] || ""
      };
      console.log("‚úÖ T√¨m th·∫•y PRO data:", latestPro);
    }
  }

  // 2. T√¨m trong allData (d·ªØ li·ªáu rework t·ª´ Tab 3 - Google Sheets) - l·∫•y b·∫£n ghi m·ªõi nh·∫•t
  let latestReworkGoogle = null;
  let latestReworkGoogleTimestamp = 0;
  
  if (allData && allData.length > 0) {
    console.log("üîç ƒêang t√¨m trong allData:", allData.length, "b·∫£n ghi");
    allData.forEach((r) => {
      const qrValue = (
        r["QR Code"] || 
        r["Qr code"] || 
        r["QR code"] || 
        r.qrCode || 
        r.qr || 
        r["QRCode"] || 
        ""
      ).toString().trim().toUpperCase();
      
      if (qrValue === qrCode.toUpperCase()) {
        const timestamp = getTimestampFromRecord(r);
        if (timestamp > latestReworkGoogleTimestamp) {
          latestReworkGoogleTimestamp = timestamp;
          latestReworkGoogle = r;
        }
      }
    });
    
    if (latestReworkGoogle) {
      const timeObj = convertTimestamp(latestReworkGoogle["Gi·ªù"] || latestReworkGoogle.gio || latestReworkGoogle["Time"]);
      const dateObj = convertTimestamp(latestReworkGoogle["Ng√†y"] || latestReworkGoogle.ngay || latestReworkGoogle["Date"]);
      
      const gio = timeObj ? 
        `${String(timeObj.getHours()).padStart(2, '0')}:${String(timeObj.getMinutes()).padStart(2, '0')}:${String(timeObj.getSeconds()).padStart(2, '0')}` : 
        (latestReworkGoogle["Gi·ªù"] || latestReworkGoogle.gio || latestReworkGoogle["Time"] || "");
      
      const ngay = dateObj ? 
        `${String(dateObj.getDate()).padStart(2, '0')}/${String(dateObj.getMonth() + 1).padStart(2, '0')}/${dateObj.getFullYear()}` : 
        (latestReworkGoogle["Ng√†y"] || latestReworkGoogle.ngay || latestReworkGoogle["Date"] || "");

      latestStatusBySource['rework_google'] = {
        source: 'rework_google',
        data: latestReworkGoogle,
        maHang: latestReworkGoogle["M√£ h√†ng"] || latestReworkGoogle.maHang || latestReworkGoogle["M√£ H√†ng"] || "",
        qrCode: qrCode.toUpperCase(),
        status: latestReworkGoogle["Tr·∫°ng th√°i"] || latestReworkGoogle.trangThai || latestReworkGoogle.status || latestReworkGoogle["Status"] || latestReworkGoogle["K·∫øt qu·∫£"] || "",
        loi: latestReworkGoogle["L·ªói c·∫ßn s·ª≠a"] || latestReworkGoogle.loiCanSua || latestReworkGoogle.moTaLoi || latestReworkGoogle["L·ªói"] || "",
        action: latestReworkGoogle["H√†nh ƒë·ªông s·ª≠a ch·ªØa"] || latestReworkGoogle.hanhDongSuaChua || latestReworkGoogle["H√†nh ƒë·ªông"] || "",
        gio: gio,
        ngay: ngay,
        nguoiThucHien: latestReworkGoogle["Ng∆∞·ªùi th·ª±c hi·ªán"] || latestReworkGoogle.maNV || latestReworkGoogle.User || latestReworkGoogle["Nh√¢n vi√™n"] || "",
        ca: latestReworkGoogle["Ca l√†m vi·ªác"] || latestReworkGoogle.caLam || latestReworkGoogle.Shift || latestReworkGoogle["Ca"] || "",
        wo: latestReworkGoogle["PO"] || latestReworkGoogle.po || latestReworkGoogle["WO"] || latestReworkGoogle["S·ªë WO"] || "",
        ghichu: latestReworkGoogle["Ghi ch√∫"] || latestReworkGoogle.ghichu || latestReworkGoogle["Note"] || ""
      };
      console.log("‚úÖ T√¨m th·∫•y rework google:", latestReworkGoogle);
    }
  }

  // 3. T√¨m trong sauTestData (d·ªØ li·ªáu PQC t·ª´ Tab 4) - l·∫•y b·∫£n ghi m·ªõi nh·∫•t
  let latestPQC = null;
  let latestPQCTimestamp = 0;
  
  if (sauTestData && sauTestData.length > 0) {
    console.log("üîç ƒêang t√¨m trong sauTestData:", sauTestData.length, "b·∫£n ghi");
    sauTestData.forEach((r) => {
      const qrValue = (
        r["QR Code"] || 
        r["QR code"] || 
        r.qrCode || 
        r.qr || 
        ""
      ).toString().trim().toUpperCase();
      
      if (qrValue === qrCode.toUpperCase()) {
        const timestamp = getTimestampFromRecord(r);
        if (timestamp > latestPQCTimestamp) {
          latestPQCTimestamp = timestamp;
          latestPQC = r;
        }
      }
    });
    
    if (latestPQC) {
      const timeObj = convertTimestamp(latestPQC["Gi·ªù"] || latestPQC.gio || latestPQC["Time"]);
      const dateObj = convertTimestamp(latestPQC["Ng√†y"] || latestPQC.ngay || latestPQC["Date"]);
      
      const gio = timeObj ? 
        `${String(timeObj.getHours()).padStart(2, '0')}:${String(timeObj.getMinutes()).padStart(2, '0')}:${String(timeObj.getSeconds()).padStart(2, '0')}` : 
        "";
      
      const ngay = dateObj ? 
        `${String(dateObj.getDate()).padStart(2, '0')}/${String(dateObj.getMonth() + 1).padStart(2, '0')}/${dateObj.getFullYear()}` : 
        "";

      latestStatusBySource['pqc'] = {
        source: 'pqc',
        data: latestPQC,
        maHang: latestPQC["M√£ h√†ng"] || latestPQC.maHang || "",
        qrCode: qrCode.toUpperCase(),
        status: latestPQC["Ph√°n ƒë·ªãnh"] || latestPQC.phanDinh || "",
        loi: latestPQC["M√¥ t·∫£ l·ªói"] || latestPQC.moTaLoi || "",
        action: "",
        gio: gio,
        ngay: ngay,
        nguoiThucHien: latestPQC["M√£ Nh√¢n Vi√™n"] || latestPQC.maNV || "",
        ca: latestPQC["Ca l√†m vi·ªác"] || latestPQC.caLam || "",
        wo: latestPQC["PO"] || latestPQC.po || "",
        ghichu: latestPQC["Ghi ch√∫"] || latestPQC.ghichu || ""
      };
      console.log("‚úÖ T√¨m th·∫•y PQC data:", latestPQC);
    }
  }

  // 4. T√¨m trong oqcData (d·ªØ li·ªáu OQC t·ª´ Tab 5) - l·∫•y b·∫£n ghi m·ªõi nh·∫•t
  let latestOQC = null;
  let latestOQCTimestamp = 0;
  
  if (oqcData && oqcData.length > 0) {
    console.log("üîç ƒêang t√¨m trong oqcData:", oqcData.length, "b·∫£n ghi");
    oqcData.forEach((r) => {
      const qrValue = (
        r["QR Code"] || 
        r["QR code"] || 
        r.qrCode || 
        r.qr || 
        ""
      ).toString().trim().toUpperCase();
      
      if (qrValue === qrCode.toUpperCase()) {
        const timestamp = getTimestampFromRecord(r);
        if (timestamp > latestOQCTimestamp) {
          latestOQCTimestamp = timestamp;
          latestOQC = r;
        }
      }
    });
    
    if (latestOQC) {
      const timeObj = convertTimestamp(latestOQC["Gi·ªù"] || latestOQC.gio || latestOQC["Time"]);
      const dateObj = convertTimestamp(latestOQC["Ng√†y"] || latestOQC.ngay || latestOQC["Date"]);
      
      const gio = timeObj ? 
        `${String(timeObj.getHours()).padStart(2, '0')}:${String(timeObj.getMinutes()).padStart(2, '0')}:${String(timeObj.getSeconds()).padStart(2, '0')}` : 
        "";
      
      const ngay = dateObj ? 
        `${String(dateObj.getDate()).padStart(2, '0')}/${String(dateObj.getMonth() + 1).padStart(2, '0')}/${dateObj.getFullYear()}` : 
        "";

      latestStatusBySource['oqc'] = {
        source: 'oqc',
        data: latestOQC,
        maHang: latestOQC["M√£ h√†ng"] || latestOQC.maHang || "",
        qrCode: qrCode.toUpperCase(),
        status: latestOQC["Ph√°n ƒë·ªãnh"] || latestOQC.phanDinh || "",
        loi: latestOQC["M√¥ t·∫£ l·ªói"] || latestOQC.moTaLoi || "",
        action: "",
        gio: gio,
        ngay: ngay,
        nguoiThucHien: latestOQC["M√£ Nh√¢n Vi√™n"] || latestOQC.maNV || "",
        ca: latestOQC["Ca l√†m vi·ªác"] || latestOQC.caLam || "",
        wo: latestOQC["PO"] || latestOQC.po || "",
        ghichu: latestOQC["Ghi ch√∫"] || latestOQC.ghichu || ""
      };
      console.log("‚úÖ T√¨m th·∫•y OQC data:", latestOQC);
    }
  }
  
  console.log("üìã Tr·∫°ng th√°i cu·ªëi c√πng t·ª´ 4 ngu·ªìn (kh√¥ng bao g·ªìm local):", Object.keys(latestStatusBySource));
  
  if (Object.keys(latestStatusBySource).length > 0) {
    currentQRCodeSpan.textContent = qrCode;
    
    // S·∫Øp x·∫øp theo th·ªùi gian m·ªõi nh·∫•t tr∆∞·ªõc
    const sortedStatuses = Object.values(latestStatusBySource).sort((a, b) => {
      const dateA = createDateFromRecord(a);
      const dateB = createDateFromRecord(b);
      return dateB - dateA;
    });
    
    let historyHTML = '';
    sortedStatuses.forEach((record, index) => {
      // X√°c ƒë·ªãnh badge cho ngu·ªìn d·ªØ li·ªáu
      let sourceBadge = '';
      let statusBadge = '';
      
      if (record.source === 'pro') {
        sourceBadge = '<span style="background:#3498db; color:white; padding:2px 6px; border-radius:3px; font-size:10px; margin-left:5px;">PRO TEST</span>';
        
        if (record.status === 'OK') {
          statusBadge = '<span class="status-badge status-completed">‚úÖ PASS TEST</span>';
        } else if (record.status === 'NG') {
          statusBadge = '<span class="status-badge status-pending">‚ùå FAIL TEST</span>';
        } else {
          statusBadge = `<span class="status-badge status-pending">${record.status || 'Ch∆∞a x√°c ƒë·ªãnh'}</span>`;
        }
      } else if (record.source === 'rework_google') {
        sourceBadge = '<span style="background:#e67e22; color:white; padding:2px 6px; border-radius:3px; font-size:10px; margin-left:5px;">REWORK</span>';
        
        const status = String(record.status || "").trim();
        if (status === 'Ho√†n th√†nh' || status === 'COMPLETED') {
          statusBadge = '<span class="status-badge status-completed">‚úÖ Ho√†n th√†nh</span>';
        } else if (status === 'ƒêang x·ª≠ l√Ω' || status === 'PENDING') {
          statusBadge = '<span class="status-badge status-pending">‚è≥ ƒêang x·ª≠ l√Ω</span>';
        } else {
          statusBadge = '<span class="status-badge status-pending">‚è≥ ƒêang x·ª≠ l√Ω</span>';
        }
      } else if (record.source === 'pqc') {
        sourceBadge = '<span style="background:#9b59b6; color:white; padding:2px 6px; border-radius:3px; font-size:10px; margin-left:5px;">PQC</span>';
        
        if (record.status === 'OK') {
          statusBadge = '<span class="status-badge status-completed">‚úÖ PQC PASS</span>';
        } else if (record.status === 'NG') {
          statusBadge = '<span class="status-badge status-pending">‚ùå PQC FAIL</span>';
        } else {
          statusBadge = `<span class="status-badge status-pending">${record.status || 'Ch∆∞a x√°c ƒë·ªãnh'}</span>`;
        }
      } else if (record.source === 'oqc') {
        sourceBadge = '<span style="background:#e74c3c; color:white; padding:2px 6px; border-radius:3px; font-size:10px; margin-left:5px;">OQC</span>';
        
        if (record.status === 'OK') {
          statusBadge = '<span class="status-badge status-completed">‚úÖ OQC PASS</span>';
        } else if (record.status === 'NG') {
          statusBadge = '<span class="status-badge status-pending">‚ùå OQC FAIL</span>';
        } else {
          statusBadge = `<span class="status-badge status-pending">${record.status || 'Ch∆∞a x√°c ƒë·ªãnh'}</span>`;
        }
      }
      
      historyHTML += `
        <div class="history-item">
          <div class="history-header">
            ${statusBadge}${sourceBadge}
            <span class="history-date">${record.ngay || 'N/A'} ${record.gio || ''}</span>
          </div>
          <div class="history-content">
            ${record.loi ? `<div class="history-error">üîß L·ªói: ${record.loi}</div>` : ''}
            ${record.action ? `<div class="history-action">üõ†Ô∏è H√†nh ƒë·ªông: ${record.action}</div>` : ''}
            ${record.ghichu ? `<div class="history-note">üìù Ghi ch√∫: ${record.ghichu}</div>` : ''}
            <div>üë§ ${record.nguoiThucHien || 'N/A'} | üïí ${record.ca || 'N/A'} | üìã ${record.wo || 'N/A'}</div>
          </div>
        </div>
      `;
    });
    
    historyContent.innerHTML = historyHTML;
    historyContainer.style.display = 'block';
    
    console.log("üéâ ƒê√£ hi·ªÉn th·ªã tr·∫°ng th√°i cu·ªëi c√πng t·ª´", Object.keys(latestStatusBySource).length, "ngu·ªìn (kh√¥ng bao g·ªìm local)");
    
  } else {
    historyContent.innerHTML = '<div class="no-history">Kh√¥ng t√¨m th·∫•y l·ªãch s·ª≠ cho QR code n√†y</div>';
    historyContainer.style.display = 'block';
    console.log("‚ùå Kh√¥ng t√¨m th·∫•y l·ªãch s·ª≠ t·ª´ 4 ngu·ªìn");
  }
}

function hideQRHistory() {
  document.getElementById('qrHistory').style.display = 'none';
}
    /* ===== Utility ===== */
    function recomputeCountsForShift(shift) {
      let completed = 0, pending = 0;
      
      // L·∫•y tr·∫°ng th√°i m·ªõi nh·∫•t cho m·ªói QR code
      const latestStatus = {};
      
      for (let i = 1; i < records.length; i++) {
        const row = records[i];
        if (row[8] === shift) {
          const qrcode = row[1];
          if (!latestStatus[qrcode] || i > latestStatus[qrcode].index) {
            latestStatus[qrcode] = {
              status: row[2],
              index: i
            };
          }
        }
      }
      
      // ƒê·∫øm counts t·ª´ tr·∫°ng th√°i m·ªõi nh·∫•t
      for (const qrcode in latestStatus) {
        if (latestStatus[qrcode].status === "COMPLETED") completed++;
        else if (latestStatus[qrcode].status === "PENDING") pending++;
      }
      
      completedCount = completed; 
      pendingCount = pending;
      document.getElementById("completedCount").textContent = completedCount;
      document.getElementById("pendingCount").textContent = pendingCount;
      updateChart();
    }

    /* ===== Login ===== */
    function login() {
      const uRaw = document.getElementById("loginUser").value.trim();
      const p = document.getElementById("loginPass").value.trim();
      const s = document.getElementById("shift").value;
      const wo = document.getElementById("wo").value.trim();
      
      if (!uRaw || !wo) { 
        document.getElementById("loginError").textContent = "‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß!"; 
        return; 
      }
      
      const u = uRaw.toUpperCase();
      if (users[u] && users[u] === p) {
        currentUser = u;
        currentShift = s;
        currentWO = wo;
        document.getElementById("currentUser").textContent = currentUser;
        document.getElementById("currentShift").textContent = currentShift;
        document.getElementById("currentWO").textContent = currentWO;
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("mainApp").style.display = "flex";
        recomputeCountsForShift(currentShift);
        renderTable();
      } else {
        document.getElementById("loginError").textContent = "‚ö†Ô∏è Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u!";
      }
    }

    /* ===== Save / Update rework ===== */
    function saveRework(status) {
      const mahang = document.getElementById("mahang").value.trim().toUpperCase();
      const qrcode = document.getElementById("qrcode").value.trim().toUpperCase();
      const loi = document.getElementById("loi").value.trim();
      const ghichu = document.getElementById("ghichu").value.trim();
      const reworkAction = document.getElementById("reworkAction").value.trim();

      if (!mahang || !qrcode) {
        document.getElementById("error").textContent = "‚ö†Ô∏è Vui l√≤ng nh·∫≠p M√£ h√†ng v√† QR Code!";
        return;
      }

      if (status === "COMPLETED" && !reworkAction) {
        document.getElementById("error").textContent = "‚ö†Ô∏è Vui l√≤ng m√¥ t·∫£ h√†nh ƒë·ªông s·ª≠a ch·ªØa!";
        return;
      }

      document.getElementById("error").textContent = "";

      const now = new Date();
      const gio = now.toLocaleTimeString("vi-VN");
      const ngay = now.toLocaleDateString("vi-VN");

      // Th√™m b·∫£n ghi m·ªõi (gi·ªØ l·∫°i l·ªãch s·ª≠)
      records.push([
        mahang,
        qrcode,
        status,
        loi,
        reworkAction,
        gio,
        ngay,
        currentUser,
        currentShift,
        currentWO,
        ghichu,
        false
      ]);

      saveLocal();
      renderTable();
      recomputeCountsForShift(currentShift);
      updateChart();

      // C·∫≠p nh·∫≠t l·∫°i l·ªãch s·ª≠ hi·ªÉn th·ªã
      showQRHistory(qrcode);

      // Reset form (gi·ªØ l·∫°i QR code v√† m√£ h√†ng ƒë·ªÉ ti·∫øp t·ª•c l√†m vi·ªác)
      document.getElementById("loi").value = "";
      document.getElementById("ghichu").value = "";
      document.getElementById("reworkAction").value = "";

      // T·ª± ƒë·ªông focus v√†o √¥ h√†nh ƒë·ªông s·ª≠a ch·ªØa
      document.getElementById("reworkAction").focus();
      
      syncToSheet();
    }

    /* ===== Render b·∫£ng ===== */
    function renderTable() {
      const tbody = document.getElementById("logTable").getElementsByTagName("tbody")[0];
      tbody.innerHTML = "";

      const search = document.getElementById("searchBox").value.toLowerCase();
      const filterStatus = document.getElementById("filterStatus").value;

      // Duy·ªát ng∆∞·ª£c ƒë·ªÉ b·∫£n ghi m·ªõi nh·∫•t hi·ªÉn th·ªã tr√™n ƒë·∫ßu
      for (let i = records.length - 1; i >= 1; i--) {
        const rowData = records[i];
        
        if (search && !rowData[0].toLowerCase().includes(search) && !rowData[1].toLowerCase().includes(search)) continue;
        if (filterStatus && rowData[2] !== filterStatus) continue;

        const tr = tbody.insertRow();
        
        // X√°c ƒë·ªãnh m√†u n·ªÅn theo tr·∫°ng th√°i
        if (rowData[2] === "COMPLETED") {
          tr.classList.add("rework-completed");
        } else if (rowData[2] === "PENDING") {
          tr.classList.add("rework-pending");
        }

        // T·∫°o c√°c c·ªôt d·ªØ li·ªáu
        for (let j = 0; j < 11; j++) {
          const td = tr.insertCell();
          if (j === 2) {
            // Hi·ªÉn th·ªã badge cho tr·∫°ng th√°i
            const badge = document.createElement("span");
            badge.className = `status-badge status-${rowData[j].toLowerCase()}`;
            badge.textContent = rowData[j] === "COMPLETED" ? "‚úÖ Ho√†n th√†nh" : "‚è≥ ƒêang x·ª≠ l√Ω";
            td.appendChild(badge);
          } else {
            td.textContent = rowData[j] || "";
          }
        }

        // Th√™m c·ªôt n√∫t x√≥a
        const tdDel = tr.insertCell();
        const btn = document.createElement("button");
        btn.textContent = "X√≥a";
        btn.style.background = "#e74c3c";
        btn.style.color = "white";
        btn.style.border = "none";
        btn.style.padding = "4px 8px";
        btn.style.borderRadius = "4px";
        btn.onclick = () => deleteRecord(i);
        tdDel.appendChild(btn);
      }
    }

    /* ===== L∆∞u local ===== */
    function saveLocal() {
      try {
        localStorage.setItem("records", JSON.stringify(records));
      } catch(e) { 
        console.warn("L∆∞u localStorage th·∫•t b·∫°i:", e); 
      }
    }

    /* ===== Xu·∫•t CSV ===== */
    function exportCSV() {
      if (!currentShift || !currentWO) {
        alert("‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p v√† ch·ªçn ca + WO tr∆∞·ªõc khi xu·∫•t file!");
        return;
      }

      let mahang = document.getElementById("mahang").value.trim();
      if (!mahang) { 
        alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p m√£ h√†ng tr∆∞·ªõc khi xu·∫•t file!"); 
        return; 
      }

      let filteredRecords = [["M√£ h√†ng","QR Code","Tr·∫°ng th√°i","L·ªói c·∫ßn s·ª≠a","H√†nh ƒë·ªông s·ª≠a ch·ªØa","Gi·ªù","Ng√†y","Ng∆∞·ªùi th·ª±c hi·ªán","Ca","WO","Ghi ch√∫"]];
      for (let i = 1; i < records.length; i++) {
        if (records[i][8] === currentShift && records[i][9] === currentWO) {
          filteredRecords.push(records[i]);
        }
      }

      if (filteredRecords.length <= 1) {
        alert("‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu n√†o cho ca n√†y!");
        return;
      }

      let now = new Date();
      let filename = `REWORK_${mahang}_${currentShift.replace(/\s+/g, "_")}_${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}.csv`;

      let csvContent = "\uFEFF" + filteredRecords.map(e => e.join(",")).join("\n");
      let blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      let link = document.createElement("a");
      if (link.download !== undefined) {
        let url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    }

    /* ===== Sync Google Sheets ===== */
    function syncToSheet() {
      const dataToSend = records
      .slice(1)
      .filter(r => !r[11]); // ch·ªâ l·∫•y d√≤ng ch∆∞a sync

      if (dataToSend.length === 0) {
        alert("‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ ƒë·ªìng b·ªô!");
        return;
      }

      console.log("D·ªØ li·ªáu rework g·ª≠i l√™n Google Sheets:", dataToSend);

      fetch(REWORK_SHEET_URL, {
        method: "POST",
        body: JSON.stringify(dataToSend),
        headers: { "Content-Type": "application/json" },
        mode: "no-cors"
      })
      .then(() => {
      alert("‚úÖ ƒê√£ g·ª≠i d·ªØ li·ªáu rework l√™n Google Sheets");

      // ƒê√°nh d·∫•u c√°c d√≤ng ƒë√£ g·ª≠i
      records = records.map(r => {
        if (r[11] === false) r[11] = true;
        return r;
      });
      saveLocal();

      console.log("ƒê√£ ƒë√°nh d·∫•u synced:", records);
    })
      .catch(err => {
        alert("‚ùå L·ªói ƒë·ªìng b·ªô: " + err);
        console.error("L·ªói g·ª≠i d·ªØ li·ªáu:", err);
      });
    }

    /* ===== B√°o c√°o cu·ªëi ca ===== */
    function endShiftReport() {
      let summary = {};
      for (let i = 1; i < records.length; i++) {
        if (records[i][8] === currentShift && records[i][9] === currentWO) {
          let mahang = records[i][0];
          let status = records[i][2];
          let loi = records[i][3];

          if (!summary[mahang]) {
            summary[mahang] = { completed: 0, pending: 0, loiCount: {} };
          }

          if (status === "COMPLETED") {
            summary[mahang].completed++;
          } else if (status === "PENDING") {
            summary[mahang].pending++;
            summary[mahang].loiCount[loi] = (summary[mahang].loiCount[loi] || 0) + 1;
          }
        }
      }

      let report = `üìä B√°o c√°o rework ca ${currentShift} (WO: ${currentWO}):\n`;
      for (let mahang in summary) {
        let completed = summary[mahang].completed;
        let pending = summary[mahang].pending;
        let total = completed + pending;
        let tyLeHoanThanh = total ? ((completed / total) * 100).toFixed(2) : 0;
        let top3 = Object.entries(summary[mahang].loiCount)
                         .sort((a,b)=>b[1]-a[1])
                         .slice(0,3)
                         .map(x => `${x[0]}(${x[1]})`)
                         .join(", ") || "Kh√¥ng c√≥";

        report += `\nüì¶ M√£ h√†ng: ${mahang}\n‚úÖ Ho√†n th√†nh: ${completed} | ‚è≥ ƒêang x·ª≠ l√Ω: ${pending} | üìà T·ª∑ l·ªá ho√†n th√†nh: ${tyLeHoanThanh}%\nüî• Top l·ªói: ${top3}\n`;
      }

      alert(report);
    }

    /* ===== Chart ===== */
    function updateChart() {
      const canvas = document.getElementById("chartRework");
      if (!canvas) return;
      
      const ctx = canvas.getContext("2d");
      if (chart) chart.destroy();
      
      try {
        chart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["Ho√†n th√†nh", "ƒêang x·ª≠ l√Ω"],
            datasets: [{
              data: [completedCount, pendingCount],
              backgroundColor: ["#2ecc71", "#f39c12"]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "50%",
            radius: "90%",
            plugins: { 
              legend: { 
                position: "right",
                labels: {
                  usePointStyle: true,
                  padding: 20
                }
              }
            }
          }
        });
      } catch(e) {
        console.error("L·ªói khi t·∫°o bi·ªÉu ƒë·ªì:", e);
      }
    }

    /* ===== X√≥a log ch·ªâ UI ===== */
    function clearLogDisplay() {
      if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·∫£ng hi·ªÉn th·ªã? (D·ªØ li·ªáu v·∫´n c√≤n l∆∞u trong b·ªô nh·ªõ)")) return;
      document.querySelector("#logTable tbody").innerHTML = "";
      alert("‚úÖ ƒê√£ x√≥a hi·ªÉn th·ªã log. D·ªØ li·ªáu g·ªëc v·∫´n c√≤n!");
    }

    /* ===== Reset to√†n b·ªô d·ªØ li·ªáu ===== */
    function resetAllData() {
      if (!confirm("‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA TO√ÄN B·ªò d·ªØ li·ªáu rework?")) return;

      const backupKey = "backup_records_" + (new Date()).toISOString();
      try {
        localStorage.setItem(backupKey, JSON.stringify(records));
      } catch(e) { console.warn("Backup th·∫•t b·∫°i:", e); }

      records = [["M√£ h√†ng","QR Code","Tr·∫°ng th√°i","L·ªói c·∫ßn s·ª≠a","H√†nh ƒë·ªông s·ª≠a ch·ªØa","Gi·ªù","Ng√†y","Ng∆∞·ªùi th·ª±c hi·ªán","Ca","WO","Ghi ch√∫"]];
      completedCount = 0; pendingCount = 0;
      saveLocal();

      renderTable();
      recomputeCountsForShift(currentShift || "");
      hideQRHistory();
      alert("‚úÖ ƒê√£ reset d·ªØ li·ªáu rework. B·∫£n backup ƒë√£ l∆∞u v√†o localStorage v·ªõi key: " + backupKey);
    }

    /* ===== X√≥a 1 d√≤ng ===== */
    function deleteRecord(index) {
      if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a d√≤ng rework n√†y?")) return;

      index = Number(index);
      if (isNaN(index) || index < 1 || index >= records.length) {
        alert("Kh√¥ng t√¨m th·∫•y b·∫£n ghi ƒë·ªÉ x√≥a.");
        return;
      }

      const deletedQR = records[index][1];
      records.splice(index, 1);
      recomputeCountsForShift(currentShift);
      
      saveLocal();
      renderTable();
      
      // C·∫≠p nh·∫≠t l·∫°i l·ªãch s·ª≠ n·∫øu ƒëang xem QR code b·ªã x√≥a
      const currentQR = document.getElementById('qrcode').value.toUpperCase();
      if (currentQR === deletedQR) {
        showQRHistory(currentQR);
      }
    }

    // ===== PH·∫¶N D·ªÆ LI·ªÜU PRO (TAB 2) =====
    function loadReferenceData(silent = false) {
      const statusEl = document.getElementById("refStatus");
      const previewEl = document.getElementById("refUrlPreview");
      const refBody = document.getElementById("refTableBody");
      const refCount = document.getElementById("refCount");

      if (!PRO_SHEET_URL || PRO_SHEET_URL.trim() === "") {
        statusEl.innerHTML = "‚ö†Ô∏è PRO_SHEET_URL ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh.";
        statusEl.style.color = "#e67e22";
        return;
      }

      previewEl.value = PRO_SHEET_URL;
      if (!silent) {
        statusEl.textContent = "‚è≥ ƒêang t·∫£i d·ªØ li·ªáu PRO...";
        statusEl.style.color = "black";
      }

      const noCacheUrl = PRO_SHEET_URL + "?t=" + Date.now();
      fetch(noCacheUrl, { method: "GET", mode: "cors", cache: "no-store" })
        .then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return res.json();
        })
        .then(data => {
          if (!Array.isArray(data)) throw new Error("D·ªØ li·ªáu PRO kh√¥ng h·ª£p l·ªá");

          proData = data;
          
          if (!silent) {
            statusEl.textContent = `‚úÖ D·ªØ li·ªáu PRO: ${proData.length} d√≤ng`;
            statusEl.style.color = "green";
          }
          
          renderReferenceTable();
        })
        .catch(err => {
          console.error("L·ªói t·∫£i d·ªØ li·ªáu PRO:", err);
          statusEl.innerHTML = `‚ùå L·ªói t·∫£i d·ªØ li·ªáu PRO: ${err.message}`;
          statusEl.style.color = "red";
        });
    }

    function renderReferenceTable() {
      const body = document.getElementById("refTableBody");
      body.innerHTML = "";

      if (!Array.isArray(proData) || proData.length === 0) {
        body.innerHTML = `<tr><td colspan="11" style="color:red;">‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu PRO</td></tr>`;
        document.getElementById("refCount").textContent = "0 d√≤ng";
        return;
      }

      // H√†m chuy·ªÉn ƒë·ªïi timestamp th√†nh gi·ªù th·ª±c t·∫ø - FIXED
      function convertTimestampToTime(timestamp) {
        if (!timestamp) return "";
        
        if (typeof timestamp === "number") {
          try {
            const baseDate = new Date('1899-12-30');
            const milliseconds = timestamp * 24 * 60 * 60 * 1000;
            const resultDate = new Date(baseDate.getTime() + milliseconds);
            
            const hours = String(resultDate.getHours()).padStart(2, '0');
            const minutes = String(resultDate.getMinutes()).padStart(2, '0');
            const seconds = String(resultDate.getSeconds()).padStart(2, '0');
            
            return `${hours}:${minutes}:${seconds}`;
          } catch (e) {
            console.error("L·ªói convert time t·ª´ number:", e);
            return timestamp.toString();
          }
        }
        
        if (typeof timestamp === "string" && timestamp.match(/^\d{1,2}:\d{1,2}:\d{1,2}$/)) {
          return timestamp;
        }
        
        if (typeof timestamp === "string") {
          try {
            const date = new Date(timestamp);
            if (!isNaN(date.getTime())) {
              const hours = String(date.getHours()).padStart(2, '0');
              const minutes = String(date.getMinutes()).padStart(2, '0');
              const seconds = String(date.getSeconds()).padStart(2, '0');
              return `${hours}:${minutes}:${seconds}`;
            }
          } catch (e) {
            console.error("L·ªói convert time t·ª´ string:", e);
          }
        }
        
        return timestamp.toString();
      }

      // H√†m chuy·ªÉn ƒë·ªïi timestamp th√†nh ng√†y th·ª±c t·∫ø - FIXED
      function convertTimestampToDate(timestamp) {
        if (!timestamp) return "";
        
        if (typeof timestamp === "number") {
          try {
            const baseDate = new Date('1899-12-30');
            const milliseconds = timestamp * 24 * 60 * 60 * 1000;
            const resultDate = new Date(baseDate.getTime() + milliseconds);
            
            const day = String(resultDate.getDate()).padStart(2, '0');
            const month = String(resultDate.getMonth() + 1).padStart(2, '0');
            const year = resultDate.getFullYear();
            
            return `${day}/${month}/${year}`;
          } catch (e) {
            console.error("L·ªói convert date t·ª´ number:", e);
            return timestamp.toString();
          }
        }
        
        if (typeof timestamp === "string" && timestamp.match(/^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4}$/)) {
          return timestamp;
        }
        
        if (typeof timestamp === "string") {
          try {
            const date = new Date(timestamp);
            if (!isNaN(date.getTime())) {
              const day = String(date.getDate()).padStart(2, '0');
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const year = date.getFullYear();
              return `${day}/${month}/${year}`;
            }
          } catch (e) {
            console.error("L·ªói convert date t·ª´ string:", e);
          }
        }
        
        return timestamp.toString();
      }

      proData.forEach((r) => {
        const tr = document.createElement("tr");

        const cells = [
          r["M√£ h√†ng"] || r.maHang || "",
          r["QR Code"] || r["QR code"] || r.qrCode || r.qr || "",
          r["Ph√°n ƒë·ªãnh"] || r["K·∫øt qu·∫£"] || r.phanDinh || "",
          r["M√¥ t·∫£ l·ªói"] || r.moTaLoi || "",
          convertTimestampToTime(r["Gi·ªù"] || r.gio || r["Time"]),
          convertTimestampToDate(r["Ng√†y"] || r.ngay || r["Date"]),
          r["S·ªë l·∫ßn xu·∫•t hi·ªán"] || r.soLan || "",
          r["M√£ Nh√¢n Vi√™n"] || r.maNV || r.User || "",
          r["Ca l√†m vi·ªác"] || r.caLam || r.Shift || "",
          r["PO"] || r.po || "",
          r["Ghi ch√∫"] || r.ghichu || "",
        ];

        cells.forEach((c) => {
          const td = document.createElement("td");
          td.textContent = c;
          tr.appendChild(td);
        });

        body.appendChild(tr);
      });

      document.getElementById("refCount").textContent = `T·ªïng PRO data: ${proData.length} d√≤ng`;
    }

    // ===== PH·∫¶N D·ªÆ LI·ªÜU PQC (TAB 4) =====
    function loadSauTestData(silent = false) {
      const statusEl = document.getElementById("sauTestStatus");
      const previewEl = document.getElementById("sauTestUrlPreview");
      const sauTestBody = document.getElementById("sauTestTableBody");
      const sauTestCount = document.getElementById("sauTestCount");

      if (!LAP_RAP_SHEET_URL || LAP_RAP_SHEET_URL.trim() === "") {
        statusEl.innerHTML = "‚ö†Ô∏è LAP_RAP_SHEET_URL ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh.";
        statusEl.style.color = "#e67e22";
        return;
      }

      previewEl.value = LAP_RAP_SHEET_URL;
      if (!silent) {
        statusEl.textContent = "‚è≥ ƒêang t·∫£i d·ªØ li·ªáu PQC...";
        statusEl.style.color = "black";
      }

      const noCacheUrl = LAP_RAP_SHEET_URL + "?t=" + Date.now();
      fetch(noCacheUrl, { method: "GET", mode: "cors", cache: "no-store" })
        .then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return res.json();
        })
        .then(data => {
          if (!Array.isArray(data)) throw new Error("D·ªØ li·ªáu L·∫Øp R√°p kh√¥ng h·ª£p l·ªá");

          sauTestData = data;
          
          if (!silent) {
            statusEl.textContent = `‚úÖ D·ªØ li·ªáu PQC: ${sauTestData.length} d√≤ng`;
            statusEl.style.color = "green";
          }
          
          renderSauTestTable();
        })
        .catch(err => {
          console.error("L·ªói t·∫£i d·ªØ li·ªáu PQC:", err);
          statusEl.innerHTML = `‚ùå L·ªói t·∫£i d·ªØ li·ªáu PQC: ${err.message}`;
          statusEl.style.color = "red";
        });
    }

    function renderSauTestTable() {
      const body = document.getElementById("sauTestTableBody");
      body.innerHTML = "";

      if (!Array.isArray(sauTestData) || sauTestData.length === 0) {
        body.innerHTML = `<tr><td colspan="11" style="color:red;">‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu PQC</td></tr>`;
        document.getElementById("sauTestCount").textContent = "0 d√≤ng";
        return;
      }

      // H√†m chuy·ªÉn ƒë·ªïi timestamp th√†nh gi·ªù th·ª±c t·∫ø - FIXED
      function convertTimestampToTime(timestamp) {
        if (!timestamp) return "";
        
        if (typeof timestamp === "number") {
          try {
            const baseDate = new Date('1899-12-30');
            const milliseconds = timestamp * 24 * 60 * 60 * 1000;
            const resultDate = new Date(baseDate.getTime() + milliseconds);
            
            const hours = String(resultDate.getHours()).padStart(2, '0');
            const minutes = String(resultDate.getMinutes()).padStart(2, '0');
            const seconds = String(resultDate.getSeconds()).padStart(2, '0');
            
            return `${hours}:${minutes}:${seconds}`;
          } catch (e) {
            console.error("L·ªói convert time t·ª´ number:", e);
            return timestamp.toString();
          }
        }
        
        if (typeof timestamp === "string" && timestamp.match(/^\d{1,2}:\d{1,2}:\d{1,2}$/)) {
          return timestamp;
        }
        
        if (typeof timestamp === "string") {
          try {
            const date = new Date(timestamp);
            if (!isNaN(date.getTime())) {
              const hours = String(date.getHours()).padStart(2, '0');
              const minutes = String(date.getMinutes()).padStart(2, '0');
              const seconds = String(date.getSeconds()).padStart(2, '0');
              return `${hours}:${minutes}:${seconds}`;
            }
          } catch (e) {
            console.error("L·ªói convert time t·ª´ string:", e);
          }
        }
        
        return timestamp.toString();
      }

      // H√†m chuy·ªÉn ƒë·ªïi timestamp th√†nh ng√†y th·ª±c t·∫ø - FIXED
      function convertTimestampToDate(timestamp) {
        if (!timestamp) return "";
        
        if (typeof timestamp === "number") {
          try {
            const baseDate = new Date('1899-12-30');
            const milliseconds = timestamp * 24 * 60 * 60 * 1000;
            const resultDate = new Date(baseDate.getTime() + milliseconds);
            
            const day = String(resultDate.getDate()).padStart(2, '0');
            const month = String(resultDate.getMonth() + 1).padStart(2, '0');
            const year = resultDate.getFullYear();
            
            return `${day}/${month}/${year}`;
          } catch (e) {
            console.error("L·ªói convert date t·ª´ number:", e);
            return timestamp.toString();
          }
        }
        
        if (typeof timestamp === "string" && timestamp.match(/^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4}$/)) {
          return timestamp;
        }
        
        if (typeof timestamp === "string") {
          try {
            const date = new Date(timestamp);
            if (!isNaN(date.getTime())) {
              const day = String(date.getDate()).padStart(2, '0');
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const year = date.getFullYear();
              return `${day}/${month}/${year}`;
            }
          } catch (e) {
            console.error("L·ªói convert date t·ª´ string:", e);
          }
        }
        
        return timestamp.toString();
      }

      sauTestData.forEach((r) => {
        const tr = document.createElement("tr");

        const cells = [
          r["M√£ h√†ng"] || r.maHang || "",
          r["QR Code"] || r["QR code"] || r.qrCode || r.qr || "",
          r["Ph√°n ƒë·ªãnh"] || r["K·∫øt qu·∫£"] || r.phanDinh || "",
          r["M√¥ t·∫£ l·ªói"] || r.moTaLoi || "",
          convertTimestampToTime(r["Gi·ªù"] || r.gio || r["Time"]),
          convertTimestampToDate(r["Ng√†y"] || r.ngay || r["Date"]),
          r["S·ªë l·∫ßn xu·∫•t hi·ªán"] || r.soLan || "",
          r["M√£ Nh√¢n Vi√™n"] || r.maNV || r.User || "",
          r["Ca l√†m vi·ªác"] || r.caLam || r.Shift || "",
          r["PO"] || r.po || "",
          r["Ghi ch√∫"] || r.ghichu || "",
        ];

        cells.forEach((c) => {
          const td = document.createElement("td");
          td.textContent = c;
          tr.appendChild(td);
        });

        body.appendChild(tr);
      });

      document.getElementById("sauTestCount").textContent = `T·ªïng PQC data: ${sauTestData.length} d√≤ng`;
    }

    // ===== PH·∫¶N D·ªÆ LI·ªÜU OQC (TAB 5) =====
    function loadOQCData(silent = false) {
      const statusEl = document.getElementById("oqcStatus");
      const previewEl = document.getElementById("oqcUrlPreview");
      const oqcBody = document.getElementById("oqcTableBody");
      const oqcCount = document.getElementById("oqcCount");

      if (!OQC_SHEET_URL || OQC_SHEET_URL.trim() === "") {
        statusEl.innerHTML = "‚ö†Ô∏è OQC_SHEET_URL ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh.";
        statusEl.style.color = "#e67e22";
        return;
      }

      previewEl.value = OQC_SHEET_URL;
      if (!silent) {
        statusEl.textContent = "‚è≥ ƒêang t·∫£i d·ªØ li·ªáu OQC...";
        statusEl.style.color = "black";
      }

      const noCacheUrl = OQC_SHEET_URL + "?t=" + Date.now();
      fetch(noCacheUrl, { method: "GET", mode: "cors", cache: "no-store" })
        .then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return res.json();
        })
        .then(data => {
          if (!Array.isArray(data)) throw new Error("D·ªØ li·ªáu OQC kh√¥ng h·ª£p l·ªá");

          oqcData = data;
          
          if (!silent) {
            statusEl.textContent = `‚úÖ D·ªØ li·ªáu OQC: ${oqcData.length} d√≤ng`;
            statusEl.style.color = "green";
          }
          
          renderOQCTable();
        })
        .catch(err => {
          console.error("L·ªói t·∫£i d·ªØ li·ªáu OQC:", err);
          statusEl.innerHTML = `‚ùå L·ªói t·∫£i d·ªØ li·ªáu OQC: ${err.message}`;
          statusEl.style.color = "red";
        });
    }

    function renderOQCTable() {
      const body = document.getElementById("oqcTableBody");
      body.innerHTML = "";

      if (!Array.isArray(oqcData) || oqcData.length === 0) {
        body.innerHTML = `<tr><td colspan="11" style="color:red;">‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu OQC</td></tr>`;
        document.getElementById("oqcCount").textContent = "0 d√≤ng";
        return;
      }

      // H√†m chuy·ªÉn ƒë·ªïi timestamp th√†nh gi·ªù th·ª±c t·∫ø - FIXED
      function convertTimestampToTime(timestamp) {
        if (!timestamp) return "";
        
        if (typeof timestamp === "number") {
          try {
            const baseDate = new Date('1899-12-30');
            const milliseconds = timestamp * 24 * 60 * 60 * 1000;
            const resultDate = new Date(baseDate.getTime() + milliseconds);
            
            const hours = String(resultDate.getHours()).padStart(2, '0');
            const minutes = String(resultDate.getMinutes()).padStart(2, '0');
            const seconds = String(resultDate.getSeconds()).padStart(2, '0');
            
            return `${hours}:${minutes}:${seconds}`;
          } catch (e) {
            console.error("L·ªói convert time t·ª´ number:", e);
            return timestamp.toString();
          }
        }
        
        if (typeof timestamp === "string" && timestamp.match(/^\d{1,2}:\d{1,2}:\d{1,2}$/)) {
          return timestamp;
        }
        
        if (typeof timestamp === "string") {
          try {
            const date = new Date(timestamp);
            if (!isNaN(date.getTime())) {
              const hours = String(date.getHours()).padStart(2, '0');
              const minutes = String(date.getMinutes()).padStart(2, '0');
              const seconds = String(date.getSeconds()).padStart(2, '0');
              return `${hours}:${minutes}:${seconds}`;
            }
          } catch (e) {
            console.error("L·ªói convert time t·ª´ string:", e);
          }
        }
        
        return timestamp.toString();
      }

      // H√†m chuy·ªÉn ƒë·ªïi timestamp th√†nh ng√†y th·ª±c t·∫ø - FIXED
      function convertTimestampToDate(timestamp) {
        if (!timestamp) return "";
        
        if (typeof timestamp === "number") {
          try {
            const baseDate = new Date('1899-12-30');
            const milliseconds = timestamp * 24 * 60 * 60 * 1000;
            const resultDate = new Date(baseDate.getTime() + milliseconds);
            
            const day = String(resultDate.getDate()).padStart(2, '0');
            const month = String(resultDate.getMonth() + 1).padStart(2, '0');
            const year = resultDate.getFullYear();
            
            return `${day}/${month}/${year}`;
          } catch (e) {
            console.error("L·ªói convert date t·ª´ number:", e);
            return timestamp.toString();
          }
        }
        
        if (typeof timestamp === "string" && timestamp.match(/^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4}$/)) {
          return timestamp;
        }
        
        if (typeof timestamp === "string") {
          try {
            const date = new Date(timestamp);
            if (!isNaN(date.getTime())) {
              const day = String(date.getDate()).padStart(2, '0');
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const year = date.getFullYear();
              return `${day}/${month}/${year}`;
            }
          } catch (e) {
            console.error("L·ªói convert date t·ª´ string:", e);
          }
        }
        
        return timestamp.toString();
      }

      oqcData.forEach((r) => {
        const tr = document.createElement("tr");

        const cells = [
          r["M√£ h√†ng"] || r.maHang || "",
          r["QR Code"] || r["QR code"] || r.qrCode || r.qr || "",
          r["Ph√°n ƒë·ªãnh"] || r["K·∫øt qu·∫£"] || r.phanDinh || "",
          r["M√¥ t·∫£ l·ªói"] || r.moTaLoi || "",
          convertTimestampToTime(r["Gi·ªù"] || r.gio || r["Time"]),
          convertTimestampToDate(r["Ng√†y"] || r.ngay || r["Date"]),
          r["S·ªë l·∫ßn xu·∫•t hi·ªán"] || r.soLan || "",
          r["M√£ Nh√¢n Vi√™n"] || r.maNV || r.User || "",
          r["Ca l√†m vi·ªác"] || r.caLam || r.Shift || "",
          r["PO"] || r.po || "",
          r["Ghi ch√∫"] || r.ghichu || "",
        ];

        cells.forEach((c) => {
          const td = document.createElement("td");
          td.textContent = c;
          tr.appendChild(td);
        });

        body.appendChild(tr);
      });

      document.getElementById("oqcCount").textContent = `T·ªïng OQC data: ${oqcData.length} d√≤ng`;
    }

    // ===== PH·∫¶N B√ÅO C√ÅO & TH·ªêNG K√ä REWORK =====
    let filteredDataGlobal = [];
    let clusterize = null;

    function parseDateString(str){
      if(!str) return null;
      str = str.toString().trim();

      const m1 = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
      if(m1){
        const d = parseInt(m1[1],10);
        const m = parseInt(m1[2],10) - 1;
        const y = parseInt(m1[3],10);
        const date = new Date(y, m, d, 12, 0, 0);
        return date;
      }

      const m2 = str.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
      if(m2){
        const y = parseInt(m2[1],10);
        const m = parseInt(m2[2],10)-1;
        const d = parseInt(m2[3],10);
        return new Date(y,m,d,12,0,0);
      }

      const d2 = new Date(str);
      if(!isNaN(d2)) return new Date(d2.getFullYear(), d2.getMonth(), d2.getDate(), 12, 0, 0);

      return null;
    }

    function populateFilters(data){
      const maSPs = new Set();
      const pos = new Set();
      data.forEach(r=>{
        if (r.maHang) maSPs.add(r.maHang);
        if (r.po) pos.add(r.po);
      });
      fillSelect("maSP",maSPs);
      fillSelect("po",pos);
    }

    function fillSelect(id, values){
      const select = document.getElementById(id);
      select.innerHTML = `<option value="">T·∫•t c·∫£</option>`;
      values.forEach(v=>select.innerHTML+=`<option value="${v}">${v}</option>`);
    }

    function reloadFromGoogle(){
  return new Promise((resolve, reject) => {
    fetch(REWORK_SHEET_URL)
      .then(res=>{
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      })
      .then(data=>{
        allData = data || [];
        populateFilters(allData);
        renderReportTable(allData);
        resolve(allData); // ‚Üê TH√äM D√íNG N√ÄY
      })
      .catch(err=>{
        console.error("Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu:", err);
        alert("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu: " + err.message);
        reject(err); // ‚Üê TH√äM D√íNG N√ÄY
      });
  });
}

    function applyFilters() {
      window.preventAutoReload = true;
      const searchQR = document.getElementById("searchQR").value.trim().toUpperCase();
      const fromDate = document.getElementById("fromDate").value;
      const toDate = document.getElementById("toDate").value;
      const maSP = document.getElementById("maSP").value;
      const po = document.getElementById("po").value;
      const statusFilter = document.getElementById("statusFilter").value;

      filteredDataGlobal = allData.filter(r => {
        let match = true;

        const qrValue = r["QR Code"] || r["Qr code"] || r["QR code"] || r.qrCode || r.qr || "";
        const maHangValue = r["M√£ h√†ng"] || r.maHang || "";
        const poValue = r["PO"] || r.po || "";
        const statusValue = r["Tr·∫°ng th√°i"] || r.trangThai || r.status || "";
        const ngayStr = r["Ng√†y"] || r.ngay;
        const ngay = parseDateString(ngayStr);

        if (searchQR && !qrValue.toString().toUpperCase().includes(searchQR)) match = false;
        if (maSP && maHangValue !== maSP) match = false;
        if (po && poValue !== po) match = false;
        if (statusFilter && statusValue !== statusFilter) match = false;

        if (fromDate && ngay < new Date(fromDate)) match = false;
        if (toDate) {
          const to = new Date(toDate);
          to.setHours(23, 59, 59, 999);
          if (ngay > to) match = false;
        }

        return match;
      });

      renderReportTable(filteredDataGlobal);
      
      alert(`‚úÖ ƒê√£ l·ªçc ƒë∆∞·ª£c ${filteredDataGlobal.length} d√≤ng rework.`);
    }

    function renderReportTable(data) {
  const rows = data.map(r => {
    let gioRaw = r["Gi·ªù"] || r.gio || "";
    let ngayRaw = r["Ng√†y"] || r.ngay || "";

    function formatDateTime(value, type="date") {
      if (!value) return "";
      try {
        const d = new Date(value);
        if (isNaN(d)) return value;
        if (type === "time") return d.toLocaleTimeString("vi-VN", { hour12: false });
        return d.toLocaleDateString("vi-VN");
      } catch {
        return value;
      }
    }

    const gio = formatDateTime(gioRaw, "time");
    const ngay = formatDateTime(ngayRaw, "date");
    
    // FIX: Ki·ªÉm tra k·ªπ h∆°n c√°c tr∆∞·ªùng c√≥ th·ªÉ c√≥ c·ªßa status
    const status = r["K·∫øt qu·∫£"] || r["Tr·∫°ng th√°i"] || r.trangThai || r.status || r["Status"] || "";
 
    console.log("üîç Debug status for QR:", r["QR Code"] || r.qrCode, "Status:", status); // Debug line
    
    // FIX: X·ª≠ l√Ω c·∫£ ch·ªØ hoa v√† ch·ªØ th∆∞·ªùng
    const statusNormalized = status.toString().toUpperCase().trim();
    
    const statusBadge = statusNormalized === "COMPLETED" ? 
      '<span class="status-badge status-completed">‚úÖ Ho√†n th√†nh</span>' : 
      '<span class="status-badge status-pending">‚è≥ ƒêang x·ª≠ l√Ω</span>';

    return `
      <tr>
        <td>${r["M√£ h√†ng"] || r.maHang || ""}</td>
        <td>${r["QR Code"] || r.qrCode || r["QR code"] || ""}</td>
        <td>${statusBadge}</td>
        <td>${r["L·ªói c·∫ßn s·ª≠a"] || r.loiCanSua || r.moTaLoi || ""}</td>
        <td>${r["H√†nh ƒë·ªông s·ª≠a ch·ªØa"] || r.hanhDongSuaChua || ""}</td>
        <td>${gio}</td>
        <td>${ngay}</td>
        <td>${r["Ng∆∞·ªùi th·ª±c hi·ªán"] || r.maNV || r.User || r["Nh√¢n vi√™n"] || ""}</td>
        <td>${r["Ca l√†m vi·ªác"] || r.caLam || r.Shift || r["Ca"] || ""}</td>
        <td>${r["PO"] || r.po || r["WO"] || ""}</td>
        <td>${r["Ghi ch√∫"] || r.ghichu || ""}</td>
      </tr>
    `;
  });

  if (!clusterize) {
    clusterize = new Clusterize({
      rows: rows,
      scrollId: 'scrollArea',
      contentId: 'clusterize-content'
    });
  } else {
    clusterize.update(rows);
  }

  const info = document.getElementById("recordCount");
  if (info) info.textContent = `T·ªïng: ${data.length} d√≤ng rework`;
}
    // Kh·ªüi t·∫°o khi trang ƒë∆∞·ª£c t·∫£i
    // Kh·ªüi t·∫°o khi trang ƒë∆∞·ª£c t·∫£i
window.onload = function() {
  recomputeCountsForShift(currentShift || "");
  renderTable();
  updateChart();

  // T·ª∞ ƒê·ªòNG LOAD T·∫§T C·∫¢ D·ªÆ LI·ªÜU KHI M·ªû APP
  console.log("üöÄ T·ª± ƒë·ªông load t·∫•t c·∫£ d·ªØ li·ªáu khi kh·ªüi ƒë·ªông app...");
  
  // Load d·ªØ li·ªáu Tab 3 (Rework)
  reloadFromGoogle().then(() => {
    console.log("‚úÖ ƒê√£ load xong d·ªØ li·ªáu Rework (Tab 3)");
  }).catch(err => {
    console.error("‚ùå L·ªói load Rework data:", err);
  });
  
  // Load d·ªØ li·ªáu Tab 2 (PRO)
  loadReferenceData(true);
  console.log("‚úÖ ƒê√£ load d·ªØ li·ªáu PRO (Tab 2)");
  
  // Load d·ªØ li·ªáu Tab 4 (PQC)
  loadSauTestData(true);
  console.log("‚úÖ ƒê√£ load d·ªØ li·ªáu PQC (Tab 4)");
  
  // Load d·ªØ li·ªáu Tab 5 (OQC)
  loadOQCData(true);
  console.log("‚úÖ ƒê√£ load d·ªØ li·ªáu OQC (Tab 5)");

  // T·ª± ƒë·ªông c·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªói 1 ph√∫t (d√π ·ªü tab n√†o)
  setInterval(function() {
    console.log("üîÑ T·ª± ƒë·ªông c·∫≠p nh·∫≠t d·ªØ li·ªáu...");
    reloadFromGoogle();
    loadReferenceData(true);
    loadSauTestData(true);
    loadOQCData(true);
  }, 60000); // 60000ms = 1 ph√∫t

  window.addEventListener("storage", (event) => {
    if (event.key === "records") {
      records = JSON.parse(event.newValue || "[]");
      renderTable();
      recomputeCountsForShift(currentShift || "");
    }
  });
}

    // AUTO UPPERCASE CHO T·∫§T C·∫¢ INPUT & TEXTAREA
    document.querySelectorAll("input[type='text'], textarea").forEach(el => {
      el.addEventListener("input", function () {
        this.value = this.value.toUpperCase();
      });
    });

    // RI√äNG √î L·ªñI C·∫¶N S·ª¨A (v√¨ d√πng datalist)
    document.getElementById("loi").addEventListener("input", function () {
        this.value = this.value.toUpperCase();
    });
  </script>
</body>

</html>
